<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body {
    font-family: 'Segoe UI', sans-serif;
    margin:0; padding:0;
    display:flex;
    min-height:100vh;
    background: #f5f6fa;
}

/* === Sidebar === */
#sidebar {
    width: 220px;
    background:#273c75;
    color:white;
    display:flex;
    flex-direction:column;
    padding:20px;
}
#sidebar h2 { text-align:center; margin-bottom:30px; }
#sidebar button {
    background:none;
    border:none;
    color:white;
    padding:10px;
    text-align:left;
    cursor:pointer;
    font-size:16px;
    margin-bottom:10px;
    border-radius:6px;
    transition:0.3s;
}
#sidebar button:hover { background:#40739e; }

/* === Main content === */
#main {
    flex:1;
    padding:20px 30px;
    overflow:auto;
}

/* === Tableaux === */
table {
    width:100%;
    border-collapse:collapse;
    margin-bottom:30px;
    background:white;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
thead { background:#273c75; color:white; }
th,td { padding:10px; text-align:center; border-bottom:1px solid #eee; }
tbody tr:hover { background:#f1f2f6; }

.action-btn { background:none; border:none; cursor:pointer; font-size:1.2em; margin:0 5px; }
.action-btn.edit { color:#273c75; }
.action-btn.delete { color:#e84118; }
.action-btn:hover { transform:scale(1.2); }

/* === Filtres === */
.filter-container { margin:15px 0; display:flex; gap:10px; }
.filter-container input { padding:8px 12px; border-radius:6px; border:1px solid #ccc; outline:none; }
.filter-container input:focus { border-color:#273c75; }

/* === Section Ouvriers === */
#listeOuvriers li { margin-bottom:6px; }

/* === Statistiques === */
#stats-section h3 { margin-bottom:10px; }

/* Responsive */
@media(max-width:900px){ body{flex-direction:column;} #sidebar{width:100%; flex-direction:row; justify-content:space-around;} }
</style>
</head>
<body>

<div id="sidebar">
    <h2>Admin Dashboard</h2>
    <button onclick="afficherSection('ouvriers')"><i class="fa-solid fa-user-group"></i> Gestion Ouvriers</button>
    <button onclick="afficherSection('taches')"><i class="fa-solid fa-tasks"></i> Gestion T√¢ches</button>
    <button onclick="afficherSection('stats')"><i class="fa-solid fa-chart-bar"></i> Statistiques</button>
</div>

<div id="main">
 
    <div id="ouvriers-section" class="section">
        <h2>üë∑ Gestion des Ouvriers</h2>
        <div class="filter-container">
            <input type="text" id="filterOuvrier" placeholder="üîé Filtrer par nom" oninput="filtrerOuvriers()">
        </div>
        <input type="text" id="nomOuvrier" placeholder="Nom de l'ouvrier">
        <button onclick="ajouterOuvrier()">Ajouter</button>
        <ul id="listeOuvriers"></ul>
    </div>

    <div id="taches-section" class="section" style="display:none;">
        <h2>üìã T√¢ches Termin√©</h2>
        <div class="filter-container">
            <input type="text" id="filterNum" placeholder="üîé Filtrer par N¬∞ Document">
            <input type="date" id="filterDate">
            <button onclick="supprimerTachesSelection()" style="background:red; color:white; padding:10px; margin:10px; border:none; border-radius:6px;">
üóëÔ∏è 

</button>
        <button onclick="window.location.href='production.html'" 
                style="background:rgb(122, 114, 114); color:white; padding:10px; margin:10px; border:none; border-radius:6px;">
            ‚ûï Taches En Cours 
        </button>
        </div>

        <table id="tableTaches">
            <thead>
                <tr>
                      <th><input type="checkbox" id="selectAll" onchange="toggleAll(this)"></th> <!-- Checkbox globale -->
                    <th>N¬∞ Document</th>
                    <th>Nom Op√©rateur</th>
                    <th>Nb Op√©rateurs</th>
                    <th>Op√©ration</th>
                    <th>Date D√©but</th>
                    <th>Date Fin</th>
                    <th>Dur√©e Pause</th>
                    <th>Cause Pause</th>
                    <th>P√©riode Totale</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>


    <div id="stats-section" class="section" style="display:none;">
        <h2>üìä Statistiques</h2>
        <h3>Temps total par machine / op√©ration</h3>
        <table id="tableStats">
            <thead>
                <tr>
                    <th>Machine / Op√©ration</th>
                    <th>Nombre de T√¢ches</th>
                    <th>Temps Total</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const API = "http://localhost:4800"; 
let tachesData = [];
let ouvriersData = [];


function afficherSection(section){
    document.getElementById('taches-section').style.display = section==='taches'?'block':'none';
    document.getElementById('stats-section').style.display = section==='stats'?'block':'none';
    document.getElementById('ouvriers-section').style.display = section==='ouvriers'?'block':'none';
}


async function afficherTaches(){
    const res = await fetch(`${API}/historique`);
    const data = await res.json();
    tachesData = data;
    remplirTableau(data);
    afficherStats();
}
function remplirTableau(data){
    const tbody = document.querySelector('#tableTaches tbody');
    tbody.innerHTML = '';
    data.forEach(t=>{
        const dateDebut = new Date(t.dateDebut);
        const dateFin = t.dateFin ? new Date(t.dateFin) : null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
        <td><input type="checkbox" class="selectTache" value="${t.id}"></td>

            <td>${t.nDocument}</td>
            <td>${t.nomOperateur}</td>
            <td>${t.nbreOperateurs}</td>
            <td>${t.operation}</td>
            <td>${dateDebut.toLocaleString()}</td>
            <td>${dateFin?dateFin.toLocaleString():'-'}</td>
            <td>${formatHMS(t.dureePause||0)}</td>
            <td>${t.causePause||'-'}</td>
            <td>${formatHMS(t.periodeTotale||0)}</td>
            <td style="color:green;font-weight:bold;">FIN</td>
            <td>
                <button class="action-btn edit" onclick="modifierTache(${t.id})"><i class="fa-solid fa-pen-to-square"></i></button>
                <button class="action-btn delete" onclick="supprimerTache(${t.id})"><i class="fa-solid fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}
document.getElementById('filterNum').addEventListener('input', filtrerTaches);
document.getElementById('filterDate').addEventListener('input', filtrerTaches);
function filtrerTaches(){
    const num = document.getElementById('filterNum').value.trim().toLowerCase();
    const dateFiltre = document.getElementById('filterDate').value;
    const resultats = tachesData.filter(t=>{
        const correspondNum = t.nDocument?.toLowerCase().includes(num);
        const correspondDate = dateFiltre ? new Date(t.dateDebut).toISOString().split('T')[0]===dateFiltre : true;
        return correspondNum && correspondDate;
    });
    remplirTableau(resultats);
}
function formatHMS(totalMinutes){
    const h = Math.floor(totalMinutes/60);
    const m = Math.floor(totalMinutes%60);
    const s = Math.floor((totalMinutes-Math.floor(totalMinutes))*60);
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
async function supprimerTache(id){
    if(!confirm("üóëÔ∏è Supprimer cette t√¢che ?")) return;
    const res = await fetch(`${API}/tache/${id}`, { method:'DELETE' });
    if(res.ok){ afficherTaches(); }
}
function modifierTache(id){
    alert(`‚úèÔ∏è Modifier t√¢che ID ${id}`);
}


function afficherStats(){
    const stats = {};
    tachesData.forEach(t=>{
        const machine = t.operation || "Inconnue";
        if(!stats[machine]) stats[machine]={count:0,total:0};
        stats[machine].count +=1;
        stats[machine].total += t.periodeTotale||0;
    });
    const tbody = document.querySelector('#tableStats tbody');
    tbody.innerHTML='';
    for(const machine in stats){
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${machine}</td>
            <td>${stats[machine].count}</td>
            <td>${formatHMS(stats[machine].total)}</td>
        `;
        tbody.appendChild(tr);
    }
}
function toggleAll(master){
    const checkboxes = document.querySelectorAll('.selectTache');
    checkboxes.forEach(cb => cb.checked = master.checked);
}


async function afficherOuvriers(){
    const res = await fetch(`${API}/ouvriers`);
    const data = await res.json();
    ouvriersData = data;
    remplirOuvriers(data);
}
function remplirOuvriers(data){
    const ul = document.getElementById('listeOuvriers');
    ul.innerHTML='';
    data.forEach(o=>{
        const li = document.createElement('li');
        li.innerHTML = `
            ${o.nom} 
            <button class="action-btn edit" onclick="modifierOuvrier(${o.id})"><i class="fa-solid fa-pen-to-square"></i></button>
            <button class="action-btn delete" onclick="supprimerOuvrier(${o.id})"><i class="fa-solid fa-trash"></i></button>
        `;
        ul.appendChild(li);
    });
}
async function ajouterOuvrier(){
    const nom = document.getElementById('nomOuvrier').value.trim();
    if(!nom) return alert("Veuillez saisir un nom !");
    await fetch(`${API}/ouvrier`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({nom})});
    document.getElementById('nomOuvrier').value='';
    afficherOuvriers();
}
function filtrerOuvriers(){
    const val = document.getElementById('filterOuvrier').value.trim().toLowerCase();
    const resultats = ouvriersData.filter(o=>o.nom.toLowerCase().includes(val));
    remplirOuvriers(resultats);
}
async function supprimerOuvrier(id){
    if(!confirm("üóëÔ∏è Supprimer cet ouvrier ?")) return;
    await fetch(`${API}/ouvrier/${id}`, {method:'DELETE'});
    afficherOuvriers();
}
function modifierOuvrier(id){ alert(`‚úèÔ∏è Modifier ouvrier ID ${id}`); }
async function supprimerTachesSelection() {
    const checked = Array.from(document.querySelectorAll('.selectTache:checked')).map(cb => cb.value);
    if(checked.length === 0) { alert("Veuillez s√©lectionner au moins une t√¢che !"); return; }

    if(!confirm(`üóëÔ∏è Supprimer ${checked.length} t√¢che(s) s√©lectionn√©e(s) ?`)) return;

    for(const id of checked){
        await fetch(`${API}/tache/${id}`, { method: 'DELETE' });
    }

    afficherTaches(); 
}


afficherTaches();
afficherOuvriers();
</script>

</body>
</html>
