<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Statistiques Ouvriers</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #f5f6fa, #dcdde1);
    margin: 0;
    padding: 0;
}

nav {
    background-color: #e7e8eb;
    color: #272525;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 25px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    position: sticky;
    top: 0;
    z-index: 10;
}

nav h2 {
    margin: 0;
    font-size: 20px;
}

nav button {
    background-color: #971010;
    border: none;
    color: #fff;
    font-size: 15px;
    padding: 8px 15px;
    margin-left: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}

nav button:hover {
    background-color: #b11b1b;
    transform: scale(1.05);
}

table {
    width: 80%;
    margin: 20px auto;
    border-collapse: collapse;
    border-radius: 10px;
    overflow: hidden;
    background: rgb(240, 240, 240);
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

thead {
    background-color: #971010;
    color: #fff;
}

th, td {
    padding: 12px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
}

tr:hover {
    background-color: #f7f7f7;
}

.chart-container {
    width: 80%;
    margin: 40px auto;
}

footer {
    background-color: #2b2d42;
    color: #fff;
    text-align: center;
    padding: 10px;
    font-size: 13px;
}
</style>
</head>
<body>

<nav>
    <h2>Statistiques Ouvriers</h2>
    <div>
        <button onclick="window.location.href='historique.html'">
            <i class="fa-solid fa-arrow-left"></i> Retour
        </button>
    </div>
</nav>

<h3 style="text-align:center; margin-top:20px;">Classement Ouvriers (Meilleurs & Mauvais)</h3>

<table id="statTable">
    <thead>
        <tr>
            <th>Nom Ouvrier</th>
            <th>Nombre de Pauses</th>
            <th>Cause de Pause</th>
            <th>Durée Totale Pause</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="chart-container">
    <canvas id="pauseChart"></canvas>
</div>

<footer>
    © 2025 STEB | Statistiques Ouvriers
</footer>

<script>
let historiqueData = [];

async function fetchHistorique() {
    const res = await fetch("http://192.168.1.193:3000/historique");
    const data = await res.json();
    historiqueData = data;
    afficherStatistiques();
}

function afficherStatistiques() {
    const stats = {};

    // Calculer le nombre de pauses par ouvrier et durée totale
    historiqueData.forEach(t => {
        if(!stats[t.nomOperateur]) {
            stats[t.nomOperateur] = { pauses: 0, causes: [], duree: 0 };
        }
        if(t.dureePause && t.dureePause > 0) {
            stats[t.nomOperateur].pauses += 1;
            stats[t.nomOperateur].causes.push(t.causePause || "Inconnue");
            stats[t.nomOperateur].duree += t.dureePause;
        }
    });

    // Trier par nombre de pauses (meilleur = moins de pauses)
    const sorted = Object.entries(stats).sort((a,b) => a[1].pauses - b[1].pauses);

    // Remplir le tableau
    const tbody = document.querySelector("#statTable tbody");
    tbody.innerHTML = "";
    sorted.forEach(([nom, val]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${nom}</td>
            <td>${val.pauses}</td>
            <td>${val.causes.join(", ") || '-'}</td>
            <td>${formatHMS(val.duree)}</td>
        `;
        tbody.appendChild(tr);
    });

    // Créer un graphique
    const ctx = document.getElementById('pauseChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sorted.map(e => e[0]),
            datasets: [{
                label: 'Nombre de Pauses',
                data: sorted.map(e => e[1].pauses),
                backgroundColor: sorted.map(e => e[1].pauses === 0 ? 'green' : 'red')
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            }
        }
    });
}

function formatHMS(totalMinutes) {
    const h = Math.floor(totalMinutes / 60);
    const m = Math.floor(totalMinutes % 60);
    const s = Math.floor((totalMinutes - Math.floor(totalMinutes)) * 60);
    return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

fetchHistorique();
</script>

</body>
</html>
